---
import { getLangFromUrl, useTranslations } from '../i18n/utils';
import HamburgerMenu from './HamburgerMenu.jsx';
import LangPicker from './LangPicker.jsx';
import ThemeToggle from './ThemeToggle.jsx';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const menuItems = [
  { href: "#home", label: t('nav.home') },
  { href: "#skills", label: t('nav.skills') },
  { href: "#projects", label: t('nav.projects') },
  { href: "#about", label: t('nav.aboutMe') },
  { href: "#contact", label: t('nav.contact') }
];
---

<nav class="fixed top-4 left-1/2 transform -translate-x-1/2 w-full max-w-6xl px-6 py-3 rounded-2xl backdrop-blur-xl bg-[var(--color-bg)]/80 border border-[var(--color-text)]/10 shadow-lg z-50 flex items-center justify-between transition-colors duration-500" role="navigation" aria-label="Barra de navegación principal">
  {/* Logo */}
  <a href="#home" class="text-[var(--color-text)] font-bold text-xl" aria-label="Inicio">Geovanni</a>

  {/* Menú Desktop */}
  <ul class="hidden md:flex gap-8 text-[var(--color-text)] font-medium text-base" role="menubar">
    {menuItems.map(item => (
      <li role="none">
        <a 
          href={item.href} 
          class="nav-link hover:text-orange-300 transition-colors duration-300 relative"
          data-target={item.href.substring(1)}
          role="menuitem"
          tabIndex={0}
        >
          {item.label}
          <span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-orange-400 transition-all duration-300 group-hover:w-full"></span>
        </a>
      </li>
    ))}
  </ul>

  {/* Menú Mobile + LangPicker */}
  <div class="md:hidden flex items-center gap-4 relative">
    <ThemeToggle client:load />
    <HamburgerMenu menuItems={menuItems} client:load />
    <LangPicker currentLang={lang} client:load />
  </div>

  {/* LangPicker Desktop */}
  <div class="hidden md:flex items-center gap-4">
    <ThemeToggle client:load />
    <LangPicker currentLang={lang} client:load />
  </div>
</nav>

<script>
  const sections = document.querySelectorAll('section');
  const navLinks = document.querySelectorAll('.nav-link');

  const observerOptions = {
    root: null,
    rootMargin: '0px',
    threshold: 0.3 // Trigger when 30% of the section is visible
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        // Remove active class from all links
        navLinks.forEach(link => {
          link.classList.remove('text-orange-400', 'font-bold');
          link.classList.add('text-[var(--color-text)]');
          // Remove underline width if we added it via class, or handle via CSS
        });

        // Add active class to the current section's link
        const activeLink = document.querySelector(`.nav-link[data-target="${entry.target.id}"]`);
        if (activeLink) {
          activeLink.classList.remove('text-[var(--color-text)]');
          activeLink.classList.add('text-orange-400', 'font-bold');
        }
      }
    });
  }, observerOptions);

  sections.forEach(section => {
    observer.observe(section);
  });
</script>
