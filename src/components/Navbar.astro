---
import { getLangFromUrl, useTranslations } from "../i18n/utils";
import HamburgerMenu from "./HamburgerMenu.jsx";
import LangPicker from "./LangPicker.jsx";
import ThemeToggle from "./ThemeToggle.jsx";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const isHome = Astro.url.pathname === "/" || Astro.url.pathname === "/en/";
const homePath = lang === "es" ? "/" : "/en/";

const menuItems = [
  { href: isHome ? "#home" : `${homePath}#home`, label: t("nav.home") },
  { href: isHome ? "#skills" : `${homePath}#skills`, label: t("nav.skills") },
  {
    href: isHome ? "#projects" : `${homePath}#projects`,
    label: t("nav.projects"),
  },
  { href: `/${lang === "es" ? "" : "en/"}blog`, label: t("nav.blog") },
  { href: isHome ? "#about" : `${homePath}#about`, label: t("nav.aboutMe") },
  {
    href: isHome ? "#contact" : `${homePath}#contact`,
    label: t("nav.contact"),
  },
];
---

<nav
  class="fixed top-4 left-1/2 transform -translate-x-1/2 w-full max-w-6xl px-8 py-4 rounded-3xl backdrop-blur-2xl backdrop-saturate-150 bg-[var(--color-card-bg)] border border-white/5 shadow-2xl z-50 flex items-center justify-between transition-all duration-500"
  role="navigation"
  aria-label="Barra de navegación principal"
>
  {/* Logo */}
  <a
    href={isHome ? "#home" : `${homePath}#home`}
    class="text-[var(--color-text)] font-bold text-xl"
    aria-label="Inicio">Geovanni</a
  >

  {/* Menú Desktop */}
  <ul class="hidden md:flex gap-8 text-[var(--color-text)] font-medium text-base" role="menubar">
    {
      menuItems.map((item) => (
        <li role="none">
          <a
            href={item.href}
            class="nav-link hover:text-orange-300 transition-colors duration-300 relative"
            data-target={item.href.substring(1)}
            role="menuitem"
            tabindex="0"
          >
            {item.label}
            <span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-orange-400 transition-all duration-300 group-hover:w-full" />
          </a>
        </li>
      ))
    }
  </ul>

  {/* Menú Mobile + LangPicker */}
  <div class="md:hidden flex items-center gap-4 relative">
    <ThemeToggle client:load />
    <HamburgerMenu menuItems={menuItems} client:load />
    <LangPicker currentLang={lang} client:load />
  </div>

  {/* LangPicker Desktop */}
  <div class="hidden md:flex items-center gap-4">
    <ThemeToggle client:load />
    <LangPicker currentLang={lang} client:load />
  </div>
</nav>

<script>
  const sections = document.querySelectorAll("section");
  const navLinks = document.querySelectorAll(".nav-link");

  const observerOptions = {
    root: null,
    rootMargin: "0px",
    threshold: 0.3, // Trigger when 30% of the section is visible
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        // Remove active class from all links
        navLinks.forEach((link) => {
          link.classList.remove("text-orange-400", "font-bold");
          link.classList.add("text-[var(--color-text)]");
          // Remove underline width if we added it via class, or handle via CSS
        });

        // Add active class to the current section's link
        const activeLink = document.querySelector(`.nav-link[data-target="${entry.target.id}"]`);
        if (activeLink) {
          activeLink.classList.remove("text-[var(--color-text)]");
          activeLink.classList.add("text-orange-400", "font-bold");
        }
      }
    });
  }, observerOptions);

  sections.forEach((section) => {
    observer.observe(section);
  });
</script>
