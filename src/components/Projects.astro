---
import ProjectCarousel from '../components/ProjectCarousel.jsx';
import { getLangFromUrl, useTranslations } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const username = "Geovanni-Gonzalez";
const repos = [
  "TicTacToe-x86-ASM",
  "CalculadoraMultibase-DesktopApp"
];

const headers = {
  Authorization: `Bearer ${import.meta.env.GITHUB_TOKEN}`
};

const projects = await Promise.all(
  repos.map(async (repo) => {
    const res = await fetch(`https://api.github.com/repos/${username}/${repo}`, { headers });
    if (!res.ok) return null;
    const data = await res.json();

    let techStack = [];
    let projectImage = null;
    let description = data.description || "";

    try {
      // Leer project-info.json
      const techFileRes = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/project-info.json`, { headers });
      if (techFileRes.ok) {
        const techData = await techFileRes.json();
        const decoded = Buffer.from(techData.content, "base64").toString("utf-8");
        const json = JSON.parse(decoded);
        techStack = json.tech || [];
        description = json.description?.[lang] || json.description?.default || description;
      }

      // Buscar imagen en carpeta screenshots
      const screenshotRes = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/screenshots`, { headers });
      if (screenshotRes.ok) {
        const screenshotData = await screenshotRes.json();
        const firstImage = screenshotData.find((file: { type: string; name: string; download_url?: string }) => file.type === "file" && file.name.match(/\.(png|jpg|jpeg|webp)$/i));
        if (firstImage) projectImage = firstImage.download_url;
      }
    } catch (e) {
      console.warn(`Error al obtener datos para ${repo}:`, e);
    }

    return {
      title: data.name,
      description: description,
      repo: data.html_url,
      tech: techStack,
      image: projectImage || "/images/default-project.png"
    };
  })
);


---

<section id="projects" class="relative px-6 py-20 max-w-5xl mx-auto">
  <h2
    class="text-4xl sm:text-5xl md:text-6xl font-black text-center mb-16 tracking-tight select-none
           bg-gradient-to-r from-orange-300 via-yellow-300 to-red-400 bg-clip-text text-transparent
           relative flex flex-col items-center"
    style="text-shadow: 0 4px 24px #fff, 0 0 24px #FFA500, 0 0 32px #FF4500, 0 0 40px #FFD700;"
  >
    <span class="text-orange-100" style="text-shadow: 0 0 10px #ff6200, 0 2px 16px #ff0000;">
      {t("projects.title")}
    </span>
    <span
      class="block w-[22rem] sm:w-[28rem] h-1.5 mt-5 rounded-full bg-gradient-to-r from-red-700 via-yellow-500 to-red-700 shadow-lg animate-pulse"
      aria-hidden="true"
    ></span>  
  </h2>
  <ProjectCarousel client:load projects={projects.filter(Boolean)} />
</section>
